# Example Kepler config — runs on any machine with sh, python3, and curl
#
# Try it:
#   kepler daemon start -d
#   kepler start                  # attached mode (Ctrl+C to stop)
#   kepler start -d               # or detached mode
#   kepler ps
#   kepler logs --follow
#   kepler stop
#   kepler stop -s SIGKILL        # force kill

kepler:
  logs:
    buffer_size: 0 # Flush logs immediately (good for demos)

services:
  # A one-shot migration task that runs first then exits
  # `run:` executes via sh -c — ideal for shell scripts, pipes, and chaining
  migration:
    run: echo 'Running migrations...'; sleep 2; echo 'Migrations complete!'

  # A simple HTTP server using Python's built-in module
  # Waits for migration to finish before starting
  web:
    command: ["python3", "-m", "http.server", "8089"]
    depends_on:
      migration:
        condition: service_completed_successfully
    healthcheck:
      run: "curl -sf http://localhost:8089/ > /dev/null || exit 1"
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 2s
    restart: on-failure
    environment:
      - PYTHONUNBUFFERED=1
    hooks:
      pre_start:
        - if: ${{ not hook.initialized }}$
          run: echo "First-time setup for web server"
        - run: echo "Web server starting on port 8089"
      post_healthcheck_success:
        command: ["echo", "Web server is healthy"]

  # A background worker that runs periodic tasks
  # Waits for the web server to be healthy before starting
  worker:
    run: echo 'Worker started'; while true; do echo "[$(date +%T)] Tick"; sleep 5; done
    depends_on:
      web:
        condition: service_healthy
        restart: true # Restart worker if web restarts
    restart: always
    hooks:
      pre_start:
        run: echo "Worker waiting for web to be healthy..."
      post_exit:
        command: ["echo", "Worker exited"]
