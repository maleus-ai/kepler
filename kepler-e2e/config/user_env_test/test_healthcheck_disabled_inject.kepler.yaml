# Service runs as testuser1 with explicit USER=custom_user in environment.
# Service has user_identity: false so the explicit USER=custom_user is preserved.
# Healthcheck also has user_identity: false â€” injection is disabled at both levels.
# The healthcheck should see USER=custom_user from the service's computed_env.
# The healthcheck asserts USER == custom_user -> passes only if injection is skipped.
kepler:
  logs:
    buffer_size: 0

services:
  user-env-svc:
    command: ["sh", "-c", "sleep 300"]
    user: testuser1
    inherit_env: true
    user_identity: false
    environment:
      - USER=custom_user
    restart: no
    healthcheck:
      run: "test \"$USER\" = custom_user"
      interval: 2s
      timeout: 5s
      retries: 1
      start_period: 0s
      user_identity: false
