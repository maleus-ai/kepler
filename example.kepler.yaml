# Example Kepler config â€” runs on any machine with sh, python3, and curl
#
# Try it:
#   kepler daemon start -d
#   kepler start                  # attached mode (Ctrl+C to stop)
#   kepler start -d               # or detached mode
#   kepler ps
#   kepler logs --follow
#   kepler stop
#   kepler stop -s SIGKILL        # force kill

kepler:
  logs:
    buffer_size: 0 # Flush logs immediately (good for demos)

  hooks:
    pre_start:
      - if: "not ctx.initialized"
        run: echo "Initializing services for the first time..."
      - run: echo "Starting all services"
    pre_stop:
      run: echo "Stopping all services"
    pre_cleanup:
      run: echo "Cleaning up resources"

services:
  # A one-shot migration task that runs first then exits
  migration:
    command:
      [
        "sh",
        "-c",
        "echo 'Running migrations...'; sleep 2; echo 'Migrations complete!'",
      ]

  # A simple HTTP server using Python's built-in module
  # Waits for migration to finish before starting
  web:
    command: ["python3", "-m", "http.server", "8089"]
    depends_on:
      migration:
        condition: service_completed_successfully
    healthcheck:
      test:
        ["sh", "-c", "curl -sf http://localhost:8089/ > /dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 2s
    restart: on-failure
    environment:
      - PYTHONUNBUFFERED=1
    hooks:
      pre_start:
        - if: "not ctx.initialized"
          run: echo "First-time setup for web server"
        - run: echo "Web server starting on port 8089"
      post_healthcheck_success:
        command: ["echo", "Web server is healthy"]

  # A background worker that runs periodic tasks
  # Waits for the web server to be healthy before starting
  worker:
    command:
      [
        "sh",
        "-c",
        'echo ''Worker started''; while true; do echo "[$(date +%T)] Tick"; sleep 5; done',
      ]
    depends_on:
      web:
        condition: service_healthy
        restart: true # Restart worker if web restarts
    restart: always
    hooks:
      pre_start:
        run: echo "Worker waiting for web to be healthy..."
      post_exit:
        command: ["echo", "Worker exited"]
